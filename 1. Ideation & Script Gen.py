# -*- coding: utf-8 -*-
"""Idea Generation.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/11W2pN61EtpNJe7X_rTJAYZ1nKwqZsWJt
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 0 â€”Â Install packages
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
!pip install --quiet --upgrade openai python-slugify

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 1 â€”Â API key & config
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import os
from dotenv import load_dotenv

# Load API key from .env or environment
load_dotenv()

MODEL            = "gpt-4.1-nano"   # change if desired
TEMPERATURE      = 0.8
MAX_CHARACTERS   = 2500
N_CATEGORIES     = 5
N_IDEAS          = 10
DEBUG_RAW_REPLY  = False           # set True to inspect model output

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 2 â€”Â Imports & helpers
# (full overwrite)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import json, textwrap, re
from pathlib import Path
from slugify import slugify
import openai

openai.api_key = os.getenv("OPENAI_API_KEY")

# â”€â”€ Shared channel context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TLDR_DESC = (
    "You are the strategist & scriptwriter behind the YouTube channel â€œTL;DR Theater,â€ "
    "which publishes short, funny, punchy AIâ€‘generated explainer videos with AI images "
    "and TTS narration. **Rules for every script:** "
    "â€”No greetings or signâ€‘offs, "
    "â€”No channel name mentions, "
    "â€”No like/subscribe calls, "
    "â€”Narration only (no scene headers)."
)

# â”€â”€ Prompt templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYSTEM_CATEGORY = (
    f"{TLDR_DESC}\n"
    "Suggest facelessâ€‘YouTube *niche categories* the channel could explore. "
    "Return ONLY a JSON array."
)

SYSTEM_IDEA = (
    f"{TLDR_DESC}\n"
    "Generate {n} specific video ideas for the niche category: â€œ{category}â€. "
    "Each idea must be an attentionâ€‘grabbing title (â‰¤12 words). "
    "Return ONLY a JSON array."
)

SYSTEM_SCRIPT = (
    f"{TLDR_DESC}\n\n"
    "Write the full narration script for a video titled: â€œ{idea}â€. "
    "Tone = witty, playful, fastâ€‘moving. "
    "TTSâ€‘friendly (simple punctuation, no emâ€‘dashes). "
    "Limit to {MAX_CHARACTERS} characters. "
    "âš ï¸  Output ONLY the narration textâ€”no greetings or CTAs."
)

SYSTEM_EDIT = (
    f"{TLDR_DESC}\n"
    "Below is the current script between <script> tags. Rewrite per user request.\n"
    "<script>\n{script}\n</script>\n\n"
    "User instruction: â€œ{instruction}â€\n\n"
    "Return ONLY the revised narration, still â‰¤{MAX_CHARACTERS} characters."
)

# â”€â”€ Chat wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def chat(system: str, user: str = "", temperature: float = TEMPERATURE) -> str:
    messages = [{"role": "system", "content": system}]
    if user:
        messages.append({"role": "user", "content": user})
    resp = openai.chat.completions.create(
        model=MODEL,
        messages=messages,
        temperature=temperature,
    ).choices[0].message.content.strip()
    if DEBUG_RAW_REPLY:
        print("RAW â–º", resp)
    return resp

# â”€â”€ Robust JSON extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_json_list(raw: str):
    try:
        return json.loads(raw)
    except json.JSONDecodeError:
        m = re.search(r"\[.*\]", raw, re.S)
        if m:
            return json.loads(m.group(0))
        raise

# â”€â”€ Script cleanâ€‘up helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_SCENE_RX   = re.compile(r"^\s*(?:scene|shot)\s*\d*[:.\-]\s*", re.I)
_BANNED_RX  = re.compile(
    r"(tl;?dr theater|thanks for watching|subscribe|welcome to|don[â€™']t forget to)",
    re.I,
)

def strip_tags_and_banners(txt: str) -> str:
    """Remove <script> tags, scene headers, and banned greeting/CTA lines."""
    txt = re.sub(r"</?script>", "", txt, flags=re.I)
    lines = [
        ln for ln in txt.splitlines()
        if not _SCENE_RX.match(ln) and not _BANNED_RX.search(ln)
    ]
    return "\n".join(lines).strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 3 â€”Â Pick a category
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
raw_cats = chat(SYSTEM_CATEGORY, temperature=TEMPERATURE - 0.2)
categories = force_json_list(raw_cats)

print("Facelessâ€‘YouTube niche categories:\n")
for i, cat in enumerate(categories, 1):
    print(f"{i}. {cat}")

chosen_cat = categories[int(input("\nPick a category number: ")) - 1]
print("\nâœ…  Chosen category:", chosen_cat)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 4 â€”Â Pick a video idea
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
raw_ideas = chat(SYSTEM_IDEA.format(category=chosen_cat, n=N_IDEAS))
ideas = force_json_list(raw_ideas)

print(f"\nVideo ideas for â€œ{chosen_cat}â€:\n")
for i, idea in enumerate(ideas, 1):
    print(f"{i}. {idea}")

chosen_idea = ideas[int(input("\nPick an idea number: ")) - 1]
print("\nâœ…  Chosen idea:", chosen_idea)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 5 â€”Â Firstâ€‘draft script
# (full overwrite)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
raw_script = chat(
    SYSTEM_SCRIPT.format(
        idea=chosen_idea,
        MAX_CHARACTERS=MAX_CHARACTERS,
    )
)
script = strip_tags_and_banners(raw_script)

print("\nâ”€â”€ Firstâ€‘draft script â”€â”€\n")
print(textwrap.fill(script, 100))
print(f"\nLength: {len(script)} characters")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 6 â€”Â Editing loop
# (overwrite the whole cell)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while True:
    instruction = input("\nType an edit, 'regen' for fresh draft, or press Enter to finish: ").strip()
    if not instruction:
        break

    if instruction.lower() == "regen":
        raw_script = chat(
            SYSTEM_SCRIPT.format(
                idea=chosen_idea,
                MAX_CHARACTERS=MAX_CHARACTERS,
            )
        )
    else:
        raw_script = chat(
            SYSTEM_EDIT.format(
                script=script,
                instruction=instruction,
                MAX_CHARACTERS=MAX_CHARACTERS,
            ),
            temperature=TEMPERATURE,
        )

    script = strip_tags(raw_script)

    print("\nâ”€â”€ Updated script â”€â”€\n")
    print(textwrap.fill(script, 100))
    print(f"\nLength: {len(script)} characters")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BLOCKÂ 7 â€”Â Save script
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
filename = slugify(chosen_idea)[:50] + ".txt"
Path(filename).write_text(script, encoding="utfâ€‘8")
print("\nğŸ’¾  Saved:", filename)